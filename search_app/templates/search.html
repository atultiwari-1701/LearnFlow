<!DOCTYPE html>
<html>
<head>
    <title>Gemini Search</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        .loading {
            text-align: center;
            font-style: italic;
            color: gray;
        }
        .subtopic {
            margin-bottom: 20px;
        }
        .resource-button {
            margin-right: 10px;
            padding: 5px 10px;
        }
        .resource-result {
            margin-top: 10px;
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>Gemini Search</h1>
    <input type="text" id="search_input">
    <button id="search_button">Search</button>
    <div id="result_container"></div>
    <div id="loading_indicator" class="loading" style="display: none;">Loading...</div>

    <script>
        $(document).ready(function() {
            $('#search_button').click(function() {
                var searchQuery = $('#search_input').val();
                $.ajax({
                    url: '/gemini-search/search/',
                    type: 'POST',
                    data: { 'search_query': searchQuery, 'csrfmiddlewaretoken': '{{ csrf_token }}' },
                    dataType: 'json',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    beforeSend: function() {
                        $('#result_container').html('');
                        $('#loading_indicator').show();
                    },
                    success: function(response) {
                        $('#loading_indicator').hide();
                        if (response && response.result) {
                            try {
                                const parsedData = JSON.parse(response.result);
                                const data = parsedData[0];
                                displaySearchResults(data, searchQuery); // Call displaySearchResults
                            } catch (e) {
                                console.error("Error parsing JSON:", e);
                                $('#result_container').html('<p style="color:red;">Error parsing JSON: ' + e + '</p>');
                            }
                        } else if (response && response.error) {
                            $('#result_container').html('<p style="color:red;">' + response.error + '</p>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("AJAX Error:", xhr, status, error);
                        $('#loading_indicator').hide();
                        $('#result_container').html('<p style="color:red;">An error occurred: ' + error + '</p>');
                    }
                });
            });

            $(document).on('click', '.resource-button', function() {
                let subtopicName = $(this).data('subtopic');
                let resourceName = $(this).data('resource');
                let searchQuery = $('#search_input').val(); //get the search query from the input.
                let data = JSON.parse($('#json_data').text()); //get the data from the hidden element.

                generateResources(subtopicName, resourceName, searchQuery, data, $(this));
            });
        });

        function displaySearchResults(data, searchQuery) {
            $('#result_container').html('<pre id="json_data" style="display: none;">' + JSON.stringify(data, null, 2) + '</pre>'); //hide the json data
            $('#result_container').append('<pre>' + JSON.stringify(data, null, 2) + '</pre>'); //show the json data to the user.

            const subTopicsKey = "SubTopics of " + searchQuery;

            if (data[subTopicsKey] && data[subTopicsKey]["Description"] && data["Resource Tab Suggestions for " + searchQuery]) {
                const resourceTabs = data["Resource Tab Suggestions for " + searchQuery]["Description"];
                const subtopics = data[subTopicsKey]["Description"]["subtopics"];

                subtopics.forEach(subtopic => {
                    let subtopicDiv = $('<div class="subtopic"><h3>' + subtopic.name + '</h3></div>');
                    resourceTabs.forEach(resourceName => {
                        let resourceButton = $('<button class="resource-button" data-subtopic="' + subtopic.name + '" data-resource="' + resourceName + '">' + resourceName + '</button>');
                        subtopicDiv.append(resourceButton);
                    });
                    $('#result_container').append(subtopicDiv);
                });
            } else {
                console.error("SubTopics or Resource Tab Suggestions missing or incorrect.");
                $('#result_container').append('<p style="color:red;">SubTopics or Resource Tab Suggestions missing or incorrect.</p>');
            }
        }

        function generateResources(subtopicName, resourceName, searchQuery, data, buttonElement) {
    $.ajax({
        url: '/gemini-search/generate-resources/',
        type: 'POST',
        data: {
            'subtopic': subtopicName,
            'resource': resourceName,
            'search_query': searchQuery,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        dataType: 'json',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(response) {
            let subtopics = data["SubTopics of " + searchQuery]["Description"]["subtopics"];
            let subtopicObject = subtopics.find(subtopic => subtopic.name === subtopicName);

            if (subtopicObject && subtopicObject.resourceTabs) {
                // Find the index of the resource tab object if it exists, otherwise create a new object.
                let resourceTabIndex = subtopicObject.resourceTabs.findIndex(tab => Object.keys(tab)[0] === resourceName);
                if (resourceTabIndex !== -1){
                    subtopicObject.resourceTabs[resourceTabIndex][resourceName] = response.result;
                } else {
                    let newResourceTab = {};
                    newResourceTab[resourceName] = response.result;
                    subtopicObject.resourceTabs.push(newResourceTab);
                }

                $('#json_data').text(JSON.stringify(data, null, 2));
                $('#result_container pre').text(JSON.stringify(data, null, 2));

                let resultDiv = $('<div class="resource-result"><pre>' + JSON.stringify(response.result, null, 2) + '</pre></div>');
                buttonElement.after(resultDiv);
            } else {
                console.error("Subtopic object or resourceTabs is undefined.");
            }
        },
        error: function(xhr, status, error) {
            console.error("Error generating resources:", error);
        }
    });
}
    </script>
    {% csrf_token %}
</body>
</html>